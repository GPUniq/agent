# GPUniq Agent с SSH поддержкой

Этот агент позволяет запускать Docker контейнеры с SSH доступом для удаленного подключения.

## Основные возможности

- ✅ Автоматическое получение свободного порта для SSH
- ✅ Ожидание готовности SSH сервиса в контейнере
- ✅ Передача информации о подключении на сервер
- ✅ Мониторинг и управление контейнерами
- ✅ Автоматическая очистка остановленных контейнеров

## Требования

- Python 3.7+
- Docker
- Доступ к интернету для подключения к API

## Установка и запуск

1. Установите зависимости:
```bash
pip install psutil requests
```

2. Запустите агента:
```bash
python installator.py <secret_key>
```

## Создание Docker образа с SSH

Для работы с SSH необходимо создать Docker образ, который включает SSH сервер. Используйте `Dockerfile.ssh.example` как основу:

```bash
# Создайте образ
docker build -f Dockerfile.ssh.example -t my-ssh-image .

# Или используйте готовый образ с SSH
docker pull ubuntu:22.04
```

## Как это работает

1. **Получение задачи**: Агент получает задачу от сервера
2. **Запуск контейнера**: Создается Docker контейнер с пробросом SSH порта
3. **Ожидание SSH**: Агент ждет, пока SSH сервис будет готов
4. **Отправка информации**: На сервер отправляется информация о подключении:
   - IP адрес хоста
   - Порт SSH
   - Команда для подключения

## Информация о подключении

После запуска контейнера агент отправляет на сервер следующую информацию:

```json
{
  "status": "running",
  "container_id": "abc123...",
  "container_name": "task_12345",
  "ssh_host": "192.168.1.100",
  "ssh_port": 21234,
  "ssh_command": "ssh -p 21234 root@192.168.1.100",
  "output": "Container task_12345 started successfully. SSH ready on 192.168.1.100:21234"
}
```

## Подключение к контейнеру

Используйте команду SSH, полученную от агента:

```bash
ssh -p <port> root@<host>
```

По умолчанию пароль: `password`

## Мониторинг

Агент автоматически:
- Показывает список запущенных контейнеров каждые 10 минут
- Очищает остановленные контейнеры
- Логирует все операции

## Безопасность

⚠️ **Важно**: 
- Измените пароль root в Docker образе
- Используйте SSH ключи вместо паролей
- Ограничьте доступ к портам SSH
- Регулярно обновляйте образы

## Примеры использования

### Создание образа с SSH ключами

```dockerfile
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y openssh-server

# Создаем пользователя
RUN useradd -m -s /bin/bash user
RUN mkdir -p /home/user/.ssh

# Копируем публичный ключ
COPY id_rsa.pub /home/user/.ssh/authorized_keys
RUN chown -R user:user /home/user/.ssh
RUN chmod 700 /home/user/.ssh
RUN chmod 600 /home/user/.ssh/authorized_keys

# Настраиваем SSH
RUN mkdir /var/run/sshd
RUN echo 'user:password' | chpasswd

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]
```

### Подключение с SSH ключом

```bash
ssh -i ~/.ssh/id_rsa -p <port> user@<host>
```

## Устранение неполадок

### SSH не подключается
1. Проверьте, что контейнер запущен: `docker ps`
2. Проверьте логи контейнера: `docker logs <container_name>`
3. Убедитесь, что SSH сервис запущен в контейнере

### Порт занят
Агент автоматически найдет свободный порт в диапазоне 21234-21334

### Контейнер не запускается
1. Проверьте, что Docker образ существует
2. Убедитесь, что у вас есть права на запуск Docker
3. Проверьте логи агента

## API интеграция

Агент отправляет информацию о SSH подключении на сервер через API. Сервер может использовать эту информацию для:
- Отображения пользователю команды подключения
- Автоматического подключения через веб-интерфейс
- Мониторинга состояния контейнеров 